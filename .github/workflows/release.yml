name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 0.1.5)"
        required: true
        type: string

jobs:
  release:
    name: Create Release
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Application
        run: npm run build

      - name: Build Electron
        run: npm run electron:build

      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Extract Changelog
        id: changelog
        run: |
          # Extract release notes from CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # Get the first version section from CHANGELOG
            changelog_content=$(awk '/^## Version [0-9]/ {found=1; print ""; next} found && /^## / {exit} found' CHANGELOG.md || echo "")
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo "$changelog_content" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changes=Release ${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## üöÄ ExcaliNote Release v${{ steps.version.outputs.version }}

            ### üì¶ Changes

            ${{ steps.changelog.outputs.changes }}

            ### üìÅ Download

            Download the latest release for your platform:

            - **Windows**: `.exe` installer
            - **macOS**: `.dmg` file  
            - **Linux**: `.AppImage`, `.deb` or `.rpm` package

            ### üîó Installation

            See [INSTALLATION.md](INSTALLATION.md) for detailed installation instructions.
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release/*.exe
            release/*.dmg
            release/*.AppImage
            release/*.deb
            release/*.rpm
          make_latest: true
